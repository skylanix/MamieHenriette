{% extends "template.html" %}

{% block content %}
<h1>ModÃ©ration Discord</h1>

<p>Historique des actions de modÃ©ration effectuÃ©es sur le serveur Discord. Le bot enregistre automatiquement les avertissements, exclusions et bannissements.</p>

<!-- Navigation entre les sections -->
<div class="moderation-nav">
	<a href="{{ url_for('moderation') }}" class="nav-btn {{ '' if show_invites else 'active' }}">ğŸ“‹ Ã‰vÃ©nements de modÃ©ration</a>
	<a href="{{ url_for('moderation_invitations') }}" class="nav-btn {{ 'active' if show_invites else '' }}">ğŸ”— Invitations</a>
</div>

<!-- Section Statistiques -->
<div class="dashboard-section">
	<h2>ğŸ“Š Statistiques</h2>
	<div class="stats-grid">
		<div class="stat-card">
			<div class="stat-icon">ğŸ“‹</div>
			<div class="stat-content">
				<span class="stat-label">Total des sanctions</span>
				<span class="stat-value big">{{ stats.total }}</span>
			</div>
		</div>
		<div class="stat-card">
			<div class="stat-icon">â°</div>
			<div class="stat-content">
				<span class="stat-label">DerniÃ¨res 24h</span>
				<span class="stat-value big">{{ stats.recent_24h }}</span>
			</div>
		</div>
		<div class="stat-card">
			<div class="stat-icon">ğŸ“…</div>
			<div class="stat-content">
				<span class="stat-label">7 derniers jours</span>
				<span class="stat-value big">{{ stats.recent_7d }}</span>
			</div>
		</div>
		<div class="stat-card">
			<div class="stat-icon">ğŸ“†</div>
			<div class="stat-content">
				<span class="stat-label">30 derniers jours</span>
				<span class="stat-value big">{{ stats.recent_30d }}</span>
			</div>
		</div>
	</div>
</div>

<!-- Section Types de sanctions et Top modÃ©rateurs -->
<div class="moderation-insights">
	<div class="insight-card">
		<h3>ğŸ›¡ï¸ Top ModÃ©rateurs</h3>
		{% if stats.top_moderators %}
		<div class="leaderboard">
			{% for mod_name, count in stats.top_moderators %}
			<div class="leaderboard-item">
				<span class="rank">{{ loop.index }}</span>
				<span class="name">{{ mod_name }}</span>
				<span class="count">{{ count }} sanction{{ 's' if count > 1 else '' }}</span>
			</div>
			{% endfor %}
		</div>
		{% else %}
		<p class="text-muted">Aucune donnÃ©e disponible</p>
		{% endif %}
	</div>
	
	<div class="insight-card">
		<h3>âš–ï¸ Types de sanctions</h3>
		{% if stats.type_counts %}
		<div class="type-badges">
			{% for type_name, count in stats.type_counts.items() %}
			<div class="type-badge {{ type_name | lower }}">
				<span class="type-name">{{ type_name }}</span>
				<span class="type-count">{{ count }}</span>
			</div>
			{% endfor %}
		</div>
		{% else %}
		<p class="text-muted">Aucune donnÃ©e disponible</p>
		{% endif %}
	</div>
	
	<div class="insight-card">
		<h3>âš ï¸ Utilisateurs les plus sanctionnÃ©s</h3>
		{% if stats.top_sanctioned %}
		<div class="leaderboard">
			{% for username, count in stats.top_sanctioned %}
			<div class="leaderboard-item warning">
				<span class="rank">{{ loop.index }}</span>
				<span class="name">{{ username }}</span>
				<span class="count">{{ count }} sanction{{ 's' if count > 1 else '' }}</span>
			</div>
			{% endfor %}
		</div>
		{% else %}
		<p class="text-muted">Aucune donnÃ©e disponible</p>
		{% endif %}
	</div>
</div>

<!-- Section Commandes (collapsible) -->
<details class="commands-section">
	<summary>
		<span class="summary-icon">ğŸ“–</span>
		<span>Commandes de modÃ©ration disponibles</span>
	</summary>
	<div class="commands-grid">
		<div class="command-card">
			<div class="command-header">
				<code>!averto @utilisateur raison</code>
			</div>
			<p>Avertit un utilisateur et enregistre l'avertissement</p>
			<small>Alias : !warn, !av, !avertissement</small>
		</div>
		<div class="command-card">
			<div class="command-header">
				<code>!delaverto id</code>
			</div>
			<p>Retire un avertissement par son ID</p>
			<small>Alias : !removewarn, !delwarn</small>
		</div>
		<div class="command-card">
			<div class="command-header">
				<code>!warnings [@utilisateur]</code>
			</div>
			<p>Liste les Ã©vÃ©nements de modÃ©ration</p>
			<small>Alias : !listevent, !listwarn</small>
		</div>
		<div class="command-card">
			<div class="command-header">
				<code>!inspect @utilisateur</code>
			</div>
			<p>Informations dÃ©taillÃ©es sur un utilisateur</p>
			<small>Aussi : !inspect id</small>
		</div>
		<div class="command-card">
			<div class="command-header">
				<code>!kick @utilisateur raison</code>
			</div>
			<p>Expulse un utilisateur du serveur</p>
		</div>
		<div class="command-card">
			<div class="command-header">
				<code>!ban @utilisateur raison</code>
			</div>
			<p>Bannit dÃ©finitivement un utilisateur</p>
		</div>
		<div class="command-card">
			<div class="command-header">
				<code>!unban discord_id</code>
			</div>
			<p>RÃ©voque un bannissement</p>
			<small>Aussi : !unban #sanction_id raison</small>
		</div>
		<div class="command-card">
			<div class="command-header">
				<code>!banlist</code>
			</div>
			<p>Liste des utilisateurs bannis</p>
		</div>
		<div class="command-card">
			<div class="command-header">
				<code>!aide</code>
			</div>
			<p>Affiche toutes les commandes</p>
			<small>Alias : !help</small>
		</div>
	</div>
</details>

{% if not event %}
<h2>ğŸ“œ Historique des Ã©vÃ©nements</h2>
{% if events %}
<table class="moderation">
	<thead>
		<tr>
			<th>Type</th>
			<th>Utilisateur</th>
			<th>Discord ID</th>
			<th>Date & Heure</th>
			<th>Raison</th>
			<th>Staff</th>
			<th>#</th>
		</tr>
	</thead>
	<tbody>
		{% for mod_event in events %}
		<tr>
			<td><span class="event-type {{ mod_event.type | lower if mod_event.type else '' }}">{{ mod_event.type }}</span></td>
			<td>{{ mod_event.username }}</td>
			<td><code>{{ mod_event.discord_id }}</code></td>
			<td>{{ mod_event.created_at.strftime('%d/%m/%Y %H:%M') if mod_event.created_at else 'N/A' }}</td>
			<td>{{ mod_event.reason }}</td>
			<td>{{ mod_event.staff_name }}</td>
			<td>
				<a href="{{ url_for('open_edit_moderation_event', event_id = mod_event.id) }}" class="icon" title="Modifier">âœ</a>
				<a href="{{ url_for('delete_moderation_event', event_id = mod_event.id) }}" onclick="return confirm('ÃŠtes-vous sÃ»r de vouloir supprimer cet Ã©vÃ©nement ?')" class="icon" title="Supprimer">ğŸ—‘</a>
			</td>
		</tr>
		{% endfor %}
	</tbody>
</table>
{% else %}
<div class="empty-state">
	<div class="empty-icon">ğŸ‰</div>
	<p>Aucun Ã©vÃ©nement de modÃ©ration enregistrÃ©</p>
	<small>Le serveur est sage !</small>
</div>
{% endif %}
{% endif %}

{% if event %}
<h2>âœï¸ Editer un Ã©vÃ©nement</h2>
<form action="{{ url_for('update_moderation_event', event_id = event.id) }}" method="POST">
	<label for="type">Type</label>
	<input name="type" type="text" value="{{ event.type }}" disabled />
	<label for="username">Utilisateur</label>
	<input name="username" type="text" value="{{ event.username }}" disabled />
	<label for="discord_id">Discord ID</label>
	<input name="discord_id" type="text" value="{{ event.discord_id }}" disabled />
	<label for="reason">Raison</label>
	<input name="reason" type="text" value="{{ event.reason }}" required="required" />
	<label for="staff_name">Staff</label>
	<input name="staff_name" type="text" value="{{ event.staff_name }}" disabled />
	<input type="Submit" value="Modifier">
	<a href="{{ url_for('moderation') }}">Annuler</a>
</form>
{% endif %}

{% if show_invites %}
<!-- Section Invitations Discord -->
<h2>ğŸ”— Invitations Discord</h2>

<div class="invites-actions">
	<a href="{{ url_for('sync_invitations') }}" class="btn btn-primary">ğŸ”„ Synchroniser les invitations</a>
	<label class="checkbox-label">
		<input type="checkbox" id="show-revoked" {{ 'checked' if show_revoked else '' }} onchange="toggleRevoked()">
		Afficher les invitations rÃ©voquÃ©es
	</label>
</div>

{% if invite_stats %}
<!-- Statistiques des invitations -->
<div class="dashboard-section">
	<h3>ğŸ“Š Statistiques des invitations</h3>
	<div class="stats-grid">
		<div class="stat-card">
			<div class="stat-icon">ğŸ”—</div>
			<div class="stat-content">
				<span class="stat-label">Invitations actives</span>
				<span class="stat-value big">{{ invite_stats.total }}</span>
			</div>
		</div>
		<div class="stat-card">
			<div class="stat-icon">ğŸ‘¥</div>
			<div class="stat-content">
				<span class="stat-label">Utilisations totales</span>
				<span class="stat-value big">{{ invite_stats.total_uses }}</span>
			</div>
		</div>
		<div class="stat-card">
			<div class="stat-icon">â™¾ï¸</div>
			<div class="stat-content">
				<span class="stat-label">Permanentes</span>
				<span class="stat-value big">{{ invite_stats.permanent }}</span>
			</div>
		</div>
		<div class="stat-card">
			<div class="stat-icon">â³</div>
			<div class="stat-content">
				<span class="stat-label">Temporaires</span>
				<span class="stat-value big">{{ invite_stats.temporary }}</span>
			</div>
		</div>
	</div>
</div>

{% if invite_stats.top_inviters %}
<div class="moderation-insights">
	<div class="insight-card">
		<h3>ğŸ† Top inviteurs</h3>
		<div class="leaderboard">
			{% for inviter_name, uses in invite_stats.top_inviters %}
			<div class="leaderboard-item">
				<span class="rank">{{ loop.index }}</span>
				<span class="name">{{ inviter_name }}</span>
				<span class="count">{{ uses }} membre{{ 's' if uses > 1 else '' }} invitÃ©{{ 's' if uses > 1 else '' }}</span>
			</div>
			{% endfor %}
		</div>
	</div>
</div>
{% endif %}
{% endif %}

<!-- Liste des invitations -->
{% if invites %}
<table class="moderation invites-table">
	<thead>
		<tr>
			<th>Code</th>
			<th>Canal</th>
			<th>CrÃ©ateur</th>
			<th>Utilisations</th>
			<th>Max utilisations</th>
			<th>Expiration</th>
			<th>CrÃ©Ã©e le</th>
			<th>Statut</th>
			<th>#</th>
		</tr>
	</thead>
	<tbody>
		{% for invite in invites %}
		<tr class="{{ 'revoked' if invite.revoked else '' }} {{ 'expired' if invite.is_expired else '' }}">
			<td><code>{{ invite.code }}</code></td>
			<td>{{ invite.channel_name or 'N/A' }}</td>
			<td>{{ invite.inviter_name or 'Inconnu' }}</td>
			<td>{{ invite.uses or 0 }}</td>
			<td>{{ invite.max_uses if invite.max_uses > 0 else 'âˆ' }}</td>
			<td>
				{% if invite.max_age == 0 %}
					<span class="badge permanent">Jamais</span>
				{% elif invite.expires_at %}
					{{ invite.expires_at.strftime('%d/%m/%Y %H:%M') }}
				{% else %}
					N/A
				{% endif %}
			</td>
			<td>{{ invite.created_at.strftime('%d/%m/%Y %H:%M') if invite.created_at else 'N/A' }}</td>
			<td>
				{% if invite.revoked %}
					<span class="badge revoked">RÃ©voquÃ©e</span>
				{% elif invite.is_expired %}
					<span class="badge expired">ExpirÃ©e</span>
				{% elif invite.max_uses > 0 and invite.uses >= invite.max_uses %}
					<span class="badge used">Max atteint</span>
				{% else %}
					<span class="badge active">Active</span>
				{% endif %}
			</td>
			<td>
				{% if not invite.revoked %}
				<a href="{{ url_for('revoke_invitation', invite_code=invite.code) }}" 
				   onclick="return confirm('ÃŠtes-vous sÃ»r de vouloir rÃ©voquer l\'invitation {{ invite.code }} ?')" 
				   class="icon" title="RÃ©voquer">ğŸ—‘</a>
				{% endif %}
			</td>
		</tr>
		{% endfor %}
	</tbody>
</table>
{% else %}
<div class="empty-state">
	<div class="empty-icon">ğŸ”—</div>
	<p>Aucune invitation trouvÃ©e</p>
	<small>Cliquez sur "Synchroniser les invitations" pour rÃ©cupÃ©rer les invitations depuis Discord</small>
</div>
{% endif %}

<script>
function toggleRevoked() {
	const showRevoked = document.getElementById('show-revoked').checked;
	window.location.href = '{{ url_for("moderation_invitations") }}?show_revoked=' + showRevoked;
}
</script>
{% endif %}

{% endblock %}
